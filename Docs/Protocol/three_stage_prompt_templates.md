# 三阶段提示词模板体系

**版本**: 3.1  
**最后更新**: 2025-11-29  
**作者**: Manus AI

---

## 1. 核心理念

为了解决长对话中上下文遗忘的问题，我们引入三阶段提示词体系。这套体系确保在对话的不同阶段，Manus都能被重新"锚定"到核心规范和任务目标上，从而保证产出的一致性和准确性。

**v3.0更新**：加入自检流程规范、索引表和首次对话检查清单，确保每个对话都能执行质量保证和资源追溯。

---

## 2. 模板详情

### 阶段一：初始交接提示词 (Initial Handover Prompt)

**用途**: 在新对话开始时，用于引导一个新的Manus实例完整加载项目上下文。

```
你好，我需要你作为"{角色}"接手Linear任务{任务ID}。

请严格按照以下步骤同步上下文：

**第一步：克隆GitHub仓库**
1. 协议仓库：`gh repo clone gdszyy/ue5-human-ai-collab`
2. Game仓库：`gh repo clone gdszyy/ue5-human-ai-collab-game`

**第二步：阅读核心规范文档**
请阅读协议仓库`docs/`目录下的以下规范文档：
1. `docs/README.md` - 文档目录结构说明
2. `docs/collaboration_specification.md` - 人机协同开发规范
3. `docs/workflow_specification.md` - 两阶段工作流规范
4. `docs/tdd_specification.md` - TDD规范
5. `docs/self_check_specification.md` - 自检流程规范
6. `docs/first_conversation_checklist.md` - 首次对话检查清单
7. `docs/cpp_blueprint_workflow.md` - C++核心模块+蓝图连接开发模式
8. `docs/task_resource_mapping.md` - 索引表（Linear任务与资源映射表）

**第三步：查看任务相关资源**
1. 在索引表（`docs/task_resource_mapping.md`）中查找任务{任务ID}的资源位置
2. 如果有TDD，阅读`docs/tech/{系统名称}_tdd.md`
3. 如果有MHP，阅读`docs/mhp/{任务ID}_{任务简称}.md`
4. 如果有交接文档，阅读`docs/handover/{任务ID}_handover.md`
5. 如果有Game仓库代码，查看索引表中记录的代码位置

**第四步：访问Linear任务并锁定**
1. 获取任务详情：
```bash
manus-mcp-cli tool call get_issue --server linear --input '{"issue_id": "{任务ID}"}'
```

2. **检查任务状态**：
   - 如果任务状态为"In Progress"，说明其他对话正在处理此任务，**必须停止并向用户报告**
   - 如果任务状态不是"In Progress"，继续下一步

3. **立即锁定任务**（防止其他对话接取同一任务）：
```bash
manus-mcp-cli tool call update_issue --server linear --input '{"issue_id": "{任务ID}", "state": "In Progress"}'
```

**第五步：阅读游戏设计文档（如需要）**
使用Notion MCP工具获取GDD内容：
```bash
manus-mcp-cli tool call notion-fetch --server notion --input '{"page_id": "2b8bacf5f26781c0b16ccec48d9750cc"}'
```

**第六步：执行首次对话检查清单**
按照`docs/first_conversation_checklist.md`中的检查清单，确认：
- ✅ 已理解所有人机协同规范
- ✅ 已确认所有项目资源位置
- ✅ 已明确本次任务的工作要求
- ✅ 已确认本次任务的ID、标题、目标、阶段

完成上述步骤后，使用首次对话响应模板向我确认你已准备好开始{任务目标}。
```

---

### 阶段二：中期更新提示词 (Mid-session Update Prompt)

**用途**: 在长对话进行到中途，需要Manus进行文档撰写、代码提交等关键操作时，用于重新强调规范，防止上下文遗忘。

```
好的，我们已经讨论了足够多的细节。现在，请你开始{具体操作，例如：撰写技术设计文档}。

在执行操作前，请再次回顾以下核心规范，确保你的产出完全符合标准：

**1. 四层架构原则**
- 所有系统必须遵循四层架构：数据层、模拟层、粘合层、视觉层
- 参考VOI-6（世界变迁系统）和VOI-11（怪兽生成系统）的最佳实践

**2. 文档存储位置**
- TDD：`docs/tech/{系统名称}_tdd.md`
- MHP：`docs/mhp/{任务ID}_{任务简称}.md`
- 交接文档：`docs/handover/{任务ID}_handover.md`
- 代码：Game仓库`Source/EchoAlchemist/Public|Private/{模块路径}/`
- 文档：Game仓库`Docs/CoreModules/{模块名称}.md`
- 测试：Game仓库`Source/EchoAlchemist/Tests/{模块路径}/`

**3. 命名规范**
- TDD文件：`{系统名称}_tdd.md`
- MHP文件：`{任务ID}_{任务简称}.md`
- 交接文档：`{任务ID}_handover.md`
- C++类：遵循UE5命名规范（U前缀、A前缀、F前缀等）

**4. 内容规范**
- 所有文档必须包含：版本号、更新时间、作者
- TDD必须明确定义四层架构、数据结构、接口、算法
- 代码必须包含完整的注释和蓝图使用示例
- 遵循`collaboration_specification.md`和`tdd_specification.md`中定义的结构

**5. 索引表更新**
- 在创建或更新资源后，必须立即更新`docs/task_resource_mapping.md`
- 记录任务ID、标题、状态、协议仓库资源、Game仓库资源

请在确认你已理解并会严格遵守以上规范后，开始执行操作。
```

---

### 阶段三：最终交接提示词 (Final Handover Prompt)

**用途**: 在当前对话即将结束时，用于指令Manus执行自检流程、更新任务状态并生成完整的交接文档。

```
本次会话即将结束。请为任务{任务ID}执行收尾和交接工作。

**第一步：执行自检流程**
按照`docs/self_check_specification.md`中的自检清单，逐项检查：
1. 文档完整性检查：
   - [ ] TDD是否已创建？是否明确定义四层架构？
   - [ ] MHP是否已创建？是否包含实现总结？
   - [ ] 实现文档是否已创建？是否包含使用指南？
2. 代码完整性检查：
   - [ ] 头文件和实现文件是否已创建？
   - [ ] 代码是否包含完整的注释？
   - [ ] 测试是否已创建并通过？
3. Linear任务检查：
   - [ ] 任务描述是否完整？
   - [ ] 任务状态是否正确？
4. 索引表更新检查：
   - [ ] 是否已更新`docs/task_resource_mapping.md`？
   - [ ] 是否记录了所有资源位置？
5. Git提交检查：
   - [ ] 所有文档是否已提交到协议仓库？
   - [ ] 所有代码是否已提交到Game仓库？
   - [ ] 提交消息是否符合Conventional Commits规范？

**第二步：生成自检报告**
使用`docs/self_check_specification.md`中的自检报告模板，生成完整的自检报告。

**第三步：更新索引表**
确保`docs/task_resource_mapping.md`已更新，记录：
- 任务ID、标题、状态
- 协议仓库资源位置（TDD、MHP、交接文档）
- Game仓库资源位置（代码、文档、测试）
- 更新日志

**第四步：更新Linear任务状态**
- **如果任务已完成**: 将任务{任务ID}的状态更新为`{完成状态，例如：Design Complete}`
- **如果任务未完成**: 在任务{任务ID}下添加一条评论，总结本次会话的进展

**第五步：生成并提交交接文档**
1. **创建交接文档**: 在协议仓库创建`docs/handover/{任务ID}_handover.md`
2. **遵循内容规范**: 文档内容必须严格遵循`collaboration_specification.md`中定义的八大核心内容
3. **包含下一步任务**: 
   - **如果任务已完成**: 提供下一个任务的"阶段一：初始交接提示词"
   - **如果任务未完成**: 提供当前任务的"阶段一：初始交接提示词"，并说明需要继续完成的工作
4. **提交到GitHub**: 将交接文档提交到协议仓库的`docs/handover/`目录

**第六步：提交所有变更到Git**
1. 提交协议仓库的变更（TDD、MHP、交接文档、索引表）
2. 提交Game仓库的变更（代码、文档、测试）
3. 确保提交消息符合Conventional Commits规范

完成上述所有步骤后，向我提供：
1. 自检报告
2. Linear任务状态更新确认
3. 交接文档已提交确认
4. Git提交哈希
```

---

## 3. 使用流程

### 3.1 标准流程

1. **新对话开始**: 使用"阶段一：初始交接提示词"来启动一个新的Manus实例
   - Manus会执行首次对话检查清单
   - Manus会确认已理解所有规范和资源位置

2. **对话进行中**: 在需要Manus进行关键产出前，使用"阶段二：中期更新提示词"来"唤醒"它的记忆
   - 重新强调四层架构原则
   - 重新强调文档存储位置和命名规范
   - 提醒更新索引表

3. **对话结束时**: 使用"阶段三：最终交接提示词"来指令Manus执行自检流程、更新Linear状态并完成交接工作
   - Manus会执行完整的自检流程
   - Manus会生成自检报告
   - Manus会更新索引表
   - Manus会更新Linear任务状态
   - Manus会生成交接文档
   - 形成一个完美的闭环

### 3.2 质量保证机制

通过三阶段提示词体系，我们建立了完整的质量保证机制：

```
阶段一（初始）：
  - 首次对话检查清单 → 确保规范理解
  - 索引表查询 → 快速定位资源
  ↓
阶段二（中期）：
  - 规范重申 → 防止上下文遗忘
  - 索引表更新提醒 → 确保资源记录
  ↓
阶段三（结束）：
  - 自检流程 → 验证交付质量
  - 索引表更新 → 记录资源位置
  - 交接文档 → 知识沉淀
```

### 3.3 资源追溯机制

通过索引表，我们建立了完整的资源追溯机制：

```
Linear任务ID → 索引表 → 资源位置
  ↓
协议仓库资源：
  - TDD: docs/tech/{系统名称}_tdd.md
  - MHP: docs/mhp/{任务ID}_{任务简称}.md
  - 交接文档: docs/handover/{任务ID}_handover.md
  ↓
Game仓库资源：
  - 代码: Source/EchoAlchemist/Public|Private/{模块路径}/
  - 文档: Docs/CoreModules/{模块名称}.md
  - 测试: Source/EchoAlchemist/Tests/{模块路径}/
```

---

## 4. 最佳实践

### 4.1 阶段一的最佳实践

- **完整执行首次对话检查清单**：不要跳过任何步骤
- **查看索引表**：在开始工作前，先查看索引表，了解任务的资源位置和历史
- **阅读相关TDD和MHP**：如果任务有TDD或MHP，必须先阅读
- **使用首次对话响应模板**：向用户确认已完成检查

### 4.2 阶段二的最佳实践

- **在关键产出前使用**：在撰写TDD、编写代码、创建MHP等关键操作前使用
- **重新强调四层架构**：确保Manus记住四层架构原则
- **提醒更新索引表**：确保Manus在创建资源后立即更新索引表

### 4.3 阶段三的最佳实践

- **完整执行自检流程**：不要跳过任何检查项
- **生成自检报告**：使用标准模板生成自检报告
- **更新索引表**：确保所有资源位置都已记录
- **提交所有变更**：确保所有文档和代码都已提交到Git

---

## 5. 常见问题

### Q1: 如果任务没有TDD或MHP，怎么办？

A1: 在阶段一中，如果索引表显示任务没有TDD或MHP，说明这是一个新任务。Manus应该：
1. 确认任务处于设计阶段
2. 准备创建TDD
3. 在阶段三结束时创建MHP

### Q2: 如果索引表没有记录任务，怎么办？

A2: 如果索引表没有记录任务，说明这是一个全新的任务。Manus应该：
1. 立即在索引表中添加一行记录
2. 标记状态为"Backlog"或"In Progress"
3. 在阶段三结束时更新索引表，记录所有资源位置

### Q3: 如果自检流程发现问题，怎么办？

A3: 如果自检流程发现问题，Manus应该：
1. 记录问题在自检报告中
2. 修复所有问题
3. 重新执行自检流程
4. 确保所有问题都已解决后，再向用户报告

### Q4: 如果对话中途需要切换任务，怎么办？

A4: 如果对话中途需要切换任务，建议：
1. 先为当前任务执行阶段三（最终交接）
2. 然后为新任务执行阶段一（初始交接）
3. 确保两个任务的交接都完整

---

## 6. 版本历史

### v3.0 (2025-11-29)
- ✅ 加入自检流程规范到阶段三
- ✅ 加入索引表到阶段一和阶段三
- ✅ 加入首次对话检查清单到阶段一
- ✅ 更新阶段二，加入索引表更新提醒
- ✅ 完善质量保证机制和资源追溯机制

### v2.0 (2025-11-29)
- 加入TDD规范
- 加入四层架构原则
- 加入C++核心模块+蓝图连接开发模式

### v1.0 (初始版本)
- 定义三阶段提示词体系
- 创建初始交接、中期更新、最终交接三个模板

---

**参考资料**:
1. [人机协同开发规范](collaboration_specification.md)
2. [两阶段工作流规范](workflow_specification.md)
3. [TDD规范](tdd_specification.md)
4. [自检流程规范](self_check_specification.md)
5. [首次对话检查清单](first_conversation_checklist.md)
6. [索引表](task_resource_mapping.md)
7. [C++核心模块+蓝图连接开发模式](cpp_blueprint_workflow.md)
